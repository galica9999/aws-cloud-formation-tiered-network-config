{
  "Description": "Setting up launch configs",
  "Parameters": {
    "AppAMItype": {
      "Description": "Instance type for app server",
      "Type": "String",
      "Default": "t2.micro",
      "AllowedValues": [
        "t1.micro",
        "t2.nano",
        "t2.micro",
        "t2.small",
        "t2.medium",
        "t2.large",
        "m1.small",
        "m1.medium",
        "m1.large",
        "m1.xlarge",
        "m2.xlarge",
        "m2.2xlarge",
        "m2.4xlarge",
        "m3.medium",
        "m3.large",
        "m3.xlarge",
        "m3.2xlarge",
        "m4.large",
        "m4.xlarge",
        "m4.2xlarge",
        "m4.4xlarge",
        "m4.10xlarge",
        "c1.medium",
        "c1.xlarge",
        "c3.large",
        "c3.xlarge",
        "c3.2xlarge",
        "c3.4xlarge",
        "c3.8xlarge",
        "c4.large",
        "c4.xlarge",
        "c4.2xlarge",
        "c4.4xlarge",
        "c4.8xlarge",
        "g2.2xlarge",
        "g2.8xlarge",
        "r3.large",
        "r3.xlarge",
        "r3.2xlarge",
        "r3.4xlarge",
        "r3.8xlarge",
        "i2.xlarge",
        "i2.2xlarge",
        "i2.4xlarge",
        "i2.8xlarge",
        "d2.xlarge",
        "d2.2xlarge",
        "d2.4xlarge",
        "d2.8xlarge",
        "hi1.4xlarge",
        "hs1.8xlarge",
        "cr1.8xlarge",
        "cc2.8xlarge",
        "cg1.4xlarge"
      ]
    },
    "WebAMItype": {
      "Description": "Instance type for app server",
      "Type": "String",
      "Default": "t2.micro",
      "AllowedValues": [
        "t1.micro",
        "t2.nano",
        "t2.micro",
        "t2.small",
        "t2.medium",
        "t2.large",
        "m1.small",
        "m1.medium",
        "m1.large",
        "m1.xlarge",
        "m2.xlarge",
        "m2.2xlarge",
        "m2.4xlarge",
        "m3.medium",
        "m3.large",
        "m3.xlarge",
        "m3.2xlarge",
        "m4.large",
        "m4.xlarge",
        "m4.2xlarge",
        "m4.4xlarge",
        "m4.10xlarge",
        "c1.medium",
        "c1.xlarge",
        "c3.large",
        "c3.xlarge",
        "c3.2xlarge",
        "c3.4xlarge",
        "c3.8xlarge",
        "c4.large",
        "c4.xlarge",
        "c4.2xlarge",
        "c4.4xlarge",
        "c4.8xlarge",
        "g2.2xlarge",
        "g2.8xlarge",
        "r3.large",
        "r3.xlarge",
        "r3.2xlarge",
        "r3.4xlarge",
        "r3.8xlarge",
        "i2.xlarge",
        "i2.2xlarge",
        "i2.4xlarge",
        "i2.8xlarge",
        "d2.xlarge",
        "d2.2xlarge",
        "d2.4xlarge",
        "d2.8xlarge",
        "hi1.4xlarge",
        "hs1.8xlarge",
        "cr1.8xlarge",
        "cc2.8xlarge",
        "cg1.4xlarge"
      ]
    },
    "AppAMI": {
      "Description": "AMI for app server",
      "Type": "String",
      "Default": "ami-03431b5a22dff7ba3",
      "AllowedValues": ["ami-03431b5a22dff7ba3"]
    },
    "webAMI": {
      "Description": "AMI for webend server",
      "Type": "String",
      "Default": "ami-0f1909d8e1611bf25",
      "AllowedValues": ["ami-0f1909d8e1611bf25"]
    },
    "appKeyName": {
      "Description": "EC2 KeyPair to enable SSH access to the instance",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "webKeyName": {
      "Description": "EC2 KeyPair to enable SSH access to the instance",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "appCloudformationSG": { "Type": "String" },
    "webCloudformationSG": { "Type": "String" },
    "DB": { "Type": "String" },
    "DBPassword": { "Type": "String" },
    "DBUsername": { "Type": "String" }
  },
  "Resources": {
    "appLaunchConfig": {
      "Type": "AWS::EC2::LaunchTemplate",
      "Properties": {
        "LaunchTemplateData": {
          "ImageId": { "Ref": "AppAMI" },
          "InstanceType": { "Ref": "AppAMItype" },
          "KeyName": { "Ref": "appKeyName" },
          "SecurityGroupIds": [{ "Ref": "appCloudformationSG" }],
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\n",
                  "sed -i -E 's/(host:(s+)?).+,/\\1",
                  "\"",
                  { "Ref": "DB" },
                  "\"",
                  ",/g\" /var/appServer/index.js\n",
                  "sed -i -E 's/(user:(s+)?).+,/\\1",
                  "\"",
                  { "Ref": "DBUsername" },
                  "\"",
                  ",/g\" /var/appServer/index.js\n",
                  "sed -i -E 's/(password:(s+)?).+,/\\1",
                  "\"",
                  { "Ref": "DBPassword" },
                  "\"",
                  ",/g\" /var/appServer/index.js\n"
                ]
              ]
            }
          }
        }
      }
    },
    "webLaunchConfig": {
      "Type": "AWS::EC2::LaunchTemplate",
      "Properties": {
        "LaunchTemplateData": {
          "ImageId": { "Ref": "webAMI" },
          "InstanceType": { "Ref": "AppAMItype" },
          "KeyName": { "Ref": "webKeyName" },
          "SecurityGroupIds": [{ "Ref": "webCloudformationSG" }],
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\n",
                  "sed -i -E 's/(host:(s+)?).+,/\\1",
                  "\"",
                  { "Ref": "DB" },
                  "\"",
                  ",/g\" /var/appServer/index.js\n",
                  "sed -i -E 's/(user:(s+)?).+,/\\1",
                  "\"",
                  { "Ref": "DBUsername" },
                  "\"",
                  ",/g\" /var/appServer/index.js\n",
                  "sed -i -E 's/(password:(s+)?).+,/\\1",
                  "\"",
                  { "Ref": "DBPassword" },
                  "\"",
                  ",/g\" /var/appServer/index.js\n"
                ]
              ]
            }
          }
        }
      }
    }
  },
  "Outputs": {
    "appLaunchConfig": {
      "Description": "App launchconfig",
      "Value": { "Ref": "appLaunchConfig" },
      "Export": {
        "Name": { "Fn::Sub": "${AWS::StackName}-appLaunchConfig" }
      }
    },
    "webLaunchConfig": {
      "Description": "Web launchconfig",
      "Value": { "Ref": "webLaunchConfig" },
      "Export": {
        "Name": { "Fn::Sub": "${AWS::StackName}-webpLaunchConfig" }
      }
    },
    "webLaunchConfigVersion": {
      "Description": "Web launchconfig version",
      "Value": { "Fn::GetAtt": ["webLaunchConfig", "LatestVersionNumber"] },
      "Export": {
        "Name": { "Fn::Sub": "${AWS::StackName}-webLaunchConfigVersion" }
      }
    },
    "appLaunchConfigVersion": {
      "Description": "App launchconfig version",
      "Value": { "Fn::GetAtt": ["appLaunchConfig", "LatestVersionNumber"] },
      "Export": {
        "Name": { "Fn::Sub": "${AWS::StackName}-appLaunchConfigVersion" }
      }
    }
  }
}
